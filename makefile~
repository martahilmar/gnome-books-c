#
# Makefile for gnome-books-v0.01
#   - needs to install node.js to avoid cross origin requests
# 
# Runing the app: make run
#

TARGET=browser

SRC=gnome-books.c

OBJ=$(SRC:.c=.o)

CC      := gcc
CFLAGS  := -g -Wall `pkg-config --cflags gtk+-3.0 webkit2gtk-3.0`
LDFLAGS := `pkg-config --cflags --libs gtk+-3.0 webkit2gtk-3.0`

#INSTALL_NMP = nodejs -e "require('$(1)')" || npm install $(1)
INSTALL_NMP = !(npm list $(1) | grep empty) || npm install $(1)

info = echo -e "\e[34;1m" $(1) "\e[0m";

all: $(TARGET)

clone: | epub.js

epub.js:
	git clone https://github.com/futurepress/epub.js.git

setup: clone
	which nodejs || apt-get install nodejs
	which npm || apt-get install npm
	$(call INSTALL_NMP,connect)
	$(call INSTALL_NMP,colors)
	$(call INSTALL_NMP,optimist)
	$(call INSTALL_NMP,portfinder)

start_server:
	@curl http://localhost:8080 > /dev/null 2>&1 || (nodejs epub.js/server.js &)

run: setup start_server $(TARGET)
	sleep 1
	./$(TARGET)

%.o: %.c
	$(CC) -c $(CFLAGS) $< -o $@

$(TARGET): $(OBJ)
	$(CC) $< $(LDFLAGS) -o $@

clean:
	rm -rf $(OBJ)

.PHONY: setup run start_server
